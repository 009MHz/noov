  name: Pipeline Tests

  on:
    push:
    pull_request:
    workflow_dispatch:

  permissions:
    contents: read
    pages: write
    id-token: write

  jobs:
    api_tests:
      runs-on: ubuntu-latest
      steps:
        # checkout, setup python, deps...
        - name: Run API tests
          run: |
            pytest tests/api --alluredir=allure-results
        - name: Upload Allure (API)
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: allure-api
            path: allure-results
            if-no-files-found: warn
    ui_tests:
      runs-on: ubuntu-latest
      steps:
        # checkout, setup python, deps...
        - name: Run UI tests
          run: |
            pytest tests/web --base-url=https://noovoleum.com \
                   -n=auto --reruns 2 --reruns-delay 2 \
                   --alluredir=allure-results
        - name: Upload Allure (UI)
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: allure-ui
            path: allure-results
            if-no-files-found: warn
    publish:
      runs-on: ubuntu-latest
      needs: [ui_tests, api_tests]
      if: always()
      steps:
        - uses: actions/download-artifact@v4
          with:
            name: allure-ui
            path: ./allure-results/ui
        - uses: actions/download-artifact@v4
          with:
            name: allure-api
            path: ./allure-results/api
        - name: Merge results
          run: |
            mkdir -p ./allure-merged
            cp -r ./allure-results/ui/* ./allure-merged/ 2>/dev/null || true
            cp -r ./allure-results/api/* ./allure-merged/ 2>/dev/null || true
        - name: Install Allure CLI
          run: |
            curl -sL https://github.com/allure-framework/allure2/releases/latest/download/allure-2.29.0.tgz \
              | sudo tar -xz -C /opt/
            echo "/opt/allure-2.29.0/bin" >> $GITHUB_PATH
        - name: Generate Allure site
          run: allure generate ./allure-merged -o ./allure-report --clean
        - name: Upload Pages artifact
          uses: actions/upload-pages-artifact@v3
          with:
            path: ./allure-report
        - name: Deploy to GitHub Pages
          uses: actions/deploy-pages@v4
